name: ğŸ§ª æ¸¬è©¦ä¿®å¾©å¾Œçš„çˆ¬èŸ²

on:
  workflow_dispatch:
    inputs:
      test_date:
        description: 'æ¸¬è©¦æ—¥æœŸ (YYYY-MM-DD)'
        required: false
        default: '2025-06-11'
        type: string
      debug_mode:
        description: 'åµéŒ¯æ¨¡å¼'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  actions: read

jobs:
  test_crawler:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ æª¢å‡ºå„²å­˜åº«
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ğŸ“¦ å®‰è£ä¾è³´å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ§ª æ¸¬è©¦çˆ¬èŸ²åŠŸèƒ½
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        MODEL_NAME: ${{ vars.MODEL_NAME || 'gemini-2.0-flash-exp' }}
        LANGUAGE: ${{ vars.LANGUAGE || 'Traditional Chinese' }}
        CUSTOM_DATE: ${{ github.event.inputs.test_date }}
        FORCE_UPDATE: true
      run: |
        echo "ğŸ§ª é–‹å§‹æ¸¬è©¦çˆ¬èŸ²ä¿®å¾©..."
        echo "ğŸ“… æ¸¬è©¦æ—¥æœŸ: ${{ github.event.inputs.test_date }}"
        echo "ğŸ”§ åµéŒ¯æ¨¡å¼: ${{ github.event.inputs.debug_mode }}"
        
        if [[ "${{ github.event.inputs.debug_mode }}" == "true" ]]; then
          echo "ğŸ” åŸ·è¡ŒåµéŒ¯æ¨¡å¼æ¸¬è©¦..."
          export PYTHONUNBUFFERED=1
          
          # å‰µå»ºæ¸¬è©¦è…³æœ¬
          cat > test_debug.py << 'EOF'
import logging
import sys
import traceback

# è¨­å®šè©³ç´°æ—¥èªŒ
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

try:
    print("ğŸ” æ¸¬è©¦çˆ¬èŸ²åˆå§‹åŒ–...")
    from arxiv_crawler import ArxivCrawler
    
    print("âœ… çˆ¬èŸ²æ¨¡çµ„å°å…¥æˆåŠŸ")
    crawler = ArxivCrawler()
    print("âœ… çˆ¬èŸ²åˆå§‹åŒ–æˆåŠŸ")
    
    test_date = "${{ github.event.inputs.test_date }}"
    print(f"ğŸ” æ¸¬è©¦è«–æ–‡æŠ“å– (æ—¥æœŸ: {test_date})...")
    
    papers = crawler.get_papers(test_date)
    print(f"âœ… æˆåŠŸæŠ“å– {len(papers)} ç¯‡è«–æ–‡")
    
    if papers:
        print("ğŸ“„ ç¬¬ä¸€ç¯‡è«–æ–‡è³‡è¨Š:")
        paper = papers[0]
        print(f"  æ¨™é¡Œ: {paper.get('title', 'æœªçŸ¥')}")
        print(f"  ä½œè€…: {len(paper.get('authors', []))} ä½")
        print(f"  é¡åˆ¥: {paper.get('categories', [])}")
        print(f"  ID: {paper.get('arxiv_id', 'æœªçŸ¥')}")
        print(f"  é€£çµ: {paper.get('arxiv_url', 'æœªçŸ¥')}")
    else:
        print("âš ï¸ æ²’æœ‰æ‰¾åˆ°è«–æ–‡ï¼Œå¯èƒ½çš„åŸå› :")
        print("  - ç¶²è·¯é€£æ¥å•é¡Œ")
        print("  - arXiv API æš«æ™‚ä¸å¯ç”¨")
        print("  - æœå°‹æ¢ä»¶éæ–¼åš´æ ¼")
        
except Exception as e:
    print(f"âŒ æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: {e}")
    print("ğŸ” è©³ç´°éŒ¯èª¤è³‡è¨Š:")
    traceback.print_exc()
    sys.exit(1)
EOF
          
          python test_debug.py
        else
          echo "ğŸš€ åŸ·è¡Œå®Œæ•´æµç¨‹..."
          python main.py
        fi
        
    - name: ğŸ“Š æ¸¬è©¦çµæœå ±å‘Š
      if: always()
      run: |
        echo "## ğŸ§ª æ¸¬è©¦çµæœ" >> $GITHUB_STEP_SUMMARY
        echo "- **æ¸¬è©¦æ™‚é–“**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **æ¸¬è©¦æ—¥æœŸ**: ${{ github.event.inputs.test_date }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åµéŒ¯æ¨¡å¼**: ${{ github.event.inputs.debug_mode }}" >> $GITHUB_STEP_SUMMARY
        
        # æª¢æŸ¥ç”Ÿæˆçš„æª”æ¡ˆ
        if [ -f "data/${{ github.event.inputs.test_date }}.md" ]; then
          echo "- **å ±å‘Šç”Ÿæˆ**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          file_size=$(wc -c < "data/${{ github.event.inputs.test_date }}.md")
          echo "- **å ±å‘Šå¤§å°**: ${file_size} å­—ç¯€" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **å ±å‘Šç”Ÿæˆ**: âŒ å¤±æ•—" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "data/${{ github.event.inputs.test_date }}_papers.json" ]; then
          echo "- **è³‡æ–™æª”æ¡ˆ**: âœ… å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          
          # å‰µå»º Python è…³æœ¬ä¾†è¨ˆç®—è«–æ–‡æ•¸é‡
          cat > count_papers.py << 'EOF'
import json
import sys
try:
    with open('data/${{ github.event.inputs.test_date }}_papers.json', 'r') as f:
        papers = json.load(f)
    print(len(papers))
except Exception as e:
    print(0)
EOF
          
          paper_count=$(python count_papers.py)
          echo "- **è«–æ–‡æ•¸é‡**: ${paper_count} ç¯‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **è³‡æ–™æª”æ¡ˆ**: âŒ ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "## ğŸ”§ ç³»çµ±ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
        echo "- **Python ç‰ˆæœ¬**: $(python --version)" >> $GITHUB_STEP_SUMMARY
        echo "- **API é‡‘é‘°**: ${{ secrets.GOOGLE_API_KEY && 'å·²è¨­å®š' || 'æœªè¨­å®š' }}" >> $GITHUB_STEP_SUMMARY
        
        # æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
        rm -f test_debug.py count_papers.py
