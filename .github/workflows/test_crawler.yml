name: ðŸ§ª æ¸¬è©¦ä¿®å¾©å¾Œçš„çˆ¬èŸ²

on:
  workflow_dispatch:
    inputs:
      test_date:
        description: 'æ¸¬è©¦æ—¥æœŸ (YYYY-MM-DD)'
        required: false
        default: '2025-06-11'
        type: string
      debug_mode:
        description: 'åµéŒ¯æ¨¡å¼'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  actions: read

jobs:
  test_crawler:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ æª¢å‡ºå„²å­˜åº«
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ðŸ“¦ å®‰è£ä¾è³´å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ§ª æ¸¬è©¦çˆ¬èŸ²åŠŸèƒ½
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        MODEL_NAME: ${{ vars.MODEL_NAME || 'gemini-2.0-flash-exp' }}
        LANGUAGE: ${{ vars.LANGUAGE || 'Traditional Chinese' }}
        CUSTOM_DATE: ${{ github.event.inputs.test_date }}
        FORCE_UPDATE: true
      run: |
        echo "ðŸ§ª é–‹å§‹æ¸¬è©¦çˆ¬èŸ²ä¿®å¾©..."
        echo "ðŸ“… æ¸¬è©¦æ—¥æœŸ: ${{ github.event.inputs.test_date }}"
        echo "ðŸ”§ åµéŒ¯æ¨¡å¼: ${{ github.event.inputs.debug_mode }}"
        
        # å¦‚æžœå•Ÿç”¨åµéŒ¯æ¨¡å¼ï¼Œå¢žåŠ è©³ç´°æ—¥èªŒ
        if [[ "${{ github.event.inputs.debug_mode }}" == "true" ]]; then
          export PYTHONUNBUFFERED=1
          python -c "
import logging
logging.basicConfig(level=logging.DEBUG)
import sys
sys.path.append('.')
from arxiv_crawler import ArxivCrawler
import yaml

print('ðŸ” æ¸¬è©¦çˆ¬èŸ²åˆå§‹åŒ–...')
crawler = ArxivCrawler()
print('âœ… çˆ¬èŸ²åˆå§‹åŒ–æˆåŠŸ')

print('ðŸ” æ¸¬è©¦è«–æ–‡æŠ“å–...')
papers = crawler.get_papers('${{ github.event.inputs.test_date }}')
print(f'âœ… æˆåŠŸæŠ“å– {len(papers)} ç¯‡è«–æ–‡')

if papers:
    print('ðŸ“„ ç¬¬ä¸€ç¯‡è«–æ–‡è³‡è¨Š:')
    paper = papers[0]
    print(f'  æ¨™é¡Œ: {paper.get(\"title\", \"æœªçŸ¥\")}')
    print(f'  ä½œè€…: {len(paper.get(\"authors\", []))} ä½')
    print(f'  é¡žåˆ¥: {paper.get(\"categories\", [])}')
    print(f'  ID: {paper.get(\"arxiv_id\", \"æœªçŸ¥\")}')
else:
    print('âš ï¸ æ²’æœ‰æ‰¾åˆ°è«–æ–‡ï¼Œæª¢æŸ¥æ—¥æœŸæˆ–ç¶²è·¯é€£æŽ¥')
"
        else
          python main.py
        fi
        
    - name: ðŸ“Š æ¸¬è©¦çµæžœå ±å‘Š
      if: always()
      run: |
        echo "## ðŸ§ª æ¸¬è©¦çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "- **æ¸¬è©¦æ™‚é–“**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **æ¸¬è©¦æ—¥æœŸ**: ${{ github.event.inputs.test_date }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åµéŒ¯æ¨¡å¼**: ${{ github.event.inputs.debug_mode }}" >> $GITHUB_STEP_SUMMARY
        
        # æª¢æŸ¥ç”Ÿæˆçš„æª”æ¡ˆ
        if [ -f "data/${{ github.event.inputs.test_date }}.md" ]; then
          echo "- **å ±å‘Šç”Ÿæˆ**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          file_size=$(wc -c < "data/${{ github.event.inputs.test_date }}.md")
          echo "- **å ±å‘Šå¤§å°**: ${file_size} å­—ç¯€" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **å ±å‘Šç”Ÿæˆ**: âŒ å¤±æ•—" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "data/${{ github.event.inputs.test_date }}_papers.json" ]; then
          echo "- **è³‡æ–™æª”æ¡ˆ**: âœ… å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          paper_count=$(python -c "
import json
try:
    with open('data/${{ github.event.inputs.test_date }}_papers.json', 'r') as f:
        papers = json.load(f)
    print(len(papers))
except:
    print(0)
")
          echo "- **è«–æ–‡æ•¸é‡**: ${paper_count} ç¯‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **è³‡æ–™æª”æ¡ˆ**: âŒ ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "## ðŸ”§ ç³»çµ±ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
        echo "- **Python ç‰ˆæœ¬**: $(python --version)" >> $GITHUB_STEP_SUMMARY
        echo "- **API é‡‘é‘°**: ${{ secrets.GOOGLE_API_KEY && 'å·²è¨­å®š' || 'æœªè¨­å®š' }}" >> $GITHUB_STEP_SUMMARY
