# GitHub Actions è‡ªå‹•åŒ–å·¥ä½œæµç¨‹ - å®Œæ•´ç‰ˆæœ¬
# æ¯æ—¥è‡ªå‹•æŠ“å– ArXiv è«–æ–‡ä¸¦ç”Ÿæˆ AI æ‘˜è¦

name: ðŸ“š æ¯æ—¥ ArXiv è«–æ–‡æ™ºæ…§æ‘˜è¦æ›´æ–°

on:
  # å®šæ™‚åŸ·è¡Œï¼šæ¯æ—¥ UTC 16:30 (å°ç£æ™‚é–“ 00:30)
  schedule:
    - cron: "30 16 * * *"
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      custom_date:
        description: 'è‡ªè¨‚æ—¥æœŸ (YYYY-MM-DDï¼Œç•™ç©ºç‚ºä»Šæ—¥)'
        required: false
        type: string
      force_update:
        description: 'å¼·åˆ¶æ›´æ–° (å³ä½¿å·²æœ‰å ±å‘Š)'
        required: false
        type: boolean
        default: false

# æ·»åŠ å¿…è¦çš„æ¬Šé™è¨­å®š
permissions:
  contents: write
  actions: read

jobs:
  update_papers:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æª¢å‡ºå„²å­˜åº«ï¼ˆå®Œæ•´æ­·å²ï¼‰
    - name: ðŸ”„ æª¢å‡ºå„²å­˜åº«
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        ref: ${{ github.ref_name }}
      
    # 2. è¨­å®š Python ç’°å¢ƒ
    - name: ðŸ è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    # 3. å®‰è£ä¾è³´å¥—ä»¶
    - name: ðŸ“¦ å®‰è£ä¾è³´å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    # 4. è¨­å®š Git ä½¿ç”¨è€…è³‡è¨Š
    - name: âš™ï¸ è¨­å®š Git ä½¿ç”¨è€…è³‡è¨Š
      run: |
        git config --global user.email "${{ vars.EMAIL || 'action@github.com' }}"
        git config --global user.name "${{ vars.NAME || 'ArXiv Daily Bot' }}"
        
    # 5. å¼·åˆ¶åŒæ­¥é ç«¯è®Šæ›´
    - name: ðŸ”„ å¼·åˆ¶åŒæ­¥é ç«¯è®Šæ›´
      run: |
        echo "ðŸ”„ å¼·åˆ¶åŒæ­¥é ç«¯è®Šæ›´..."
        git fetch origin --prune
        git reset --hard origin/${{ github.ref_name }}
        echo "âœ… åŒæ­¥å®Œæˆï¼Œç•¶å‰ HEAD: $(git rev-parse HEAD)"
        
    # 6. åŸ·è¡Œè«–æ–‡çˆ¬èŸ²å’Œæ‘˜è¦ç”Ÿæˆ
    - name: ðŸš€ åŸ·è¡Œè«–æ–‡çˆ¬èŸ²å’Œæ‘˜è¦ç”Ÿæˆ
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        MODEL_NAME: ${{ vars.MODEL_NAME || 'gemini-2.0-flash-exp' }}
        LANGUAGE: ${{ vars.LANGUAGE || 'Traditional Chinese' }}
        CUSTOM_DATE: ${{ github.event.inputs.custom_date }}
        FORCE_UPDATE: ${{ github.event.inputs.force_update }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_NAME: ${{ github.repository }}
      run: |
        echo "ðŸš€ é–‹å§‹åŸ·è¡Œè«–æ–‡è™•ç†..."
        echo "ðŸ“… ç›®æ¨™æ—¥æœŸ: ${CUSTOM_DATE:-$(date -u '+%Y-%m-%d')}"
        echo "ðŸ”„ å¼·åˆ¶æ›´æ–°: ${FORCE_UPDATE}"
        echo "ðŸ¤– AI æ¨¡åž‹: ${MODEL_NAME}"
        
        # åŸ·è¡Œä¸»è…³æœ¬
        python main.py
        
    # 7. æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆè®Šæ›´
    - name: ðŸ“‹ æª¢æŸ¥æª”æ¡ˆè®Šæ›´
      id: check_changes
      run: |
        echo "ðŸ“‹ æª¢æŸ¥æª”æ¡ˆè®Šæ›´ç‹€æ…‹..."
        git status --porcelain
        
        if [[ -z $(git status --porcelain) ]]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ æ²’æœ‰æª”æ¡ˆè®Šæ›´ï¼Œè·³éŽæäº¤æ­¥é©Ÿ"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ åµæ¸¬åˆ°æª”æ¡ˆè®Šæ›´ï¼š"
          git status --short
        fi
        
    # 8. ðŸŽ¯ åŽŸå­åŒ–æäº¤å’ŒæŽ¨é€
    - name: ðŸŽ¯ åŽŸå­åŒ–æäº¤å’ŒæŽ¨é€
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        echo "ðŸ’« é–‹å§‹åŽŸå­åŒ–æäº¤æµç¨‹..."
        
        # è¨­å®šè®Šæ•¸
        today_date=$(date -u "+%Y-%m-%d")
        max_attempts=5
        attempt=1
        
        # ç”¢ç”Ÿæäº¤è¨Šæ¯
        if [[ -n "${{ github.event.inputs.custom_date }}" ]]; then
          commit_message="ðŸ“š è«–æ–‡æ‘˜è¦æ›´æ–°: ${{ github.event.inputs.custom_date }} (æ‰‹å‹•è§¸ç™¼)"
        else
          commit_message="ðŸ“š æ¯æ—¥è«–æ–‡æ‘˜è¦æ›´æ–°: ${today_date}"
        fi
        
        echo "ðŸ“ æäº¤è¨Šæ¯: ${commit_message}"
        
        while [ $attempt -le $max_attempts ]; do
          echo "ðŸ”„ å˜—è©¦ $attempt/$max_attempts"
          
          # é‡æ–°ç²å–æœ€æ–°ç‹€æ…‹
          git fetch origin
          
          # æª¢æŸ¥æ˜¯å¦éœ€è¦åˆä½µ
          local_commit=$(git rev-parse HEAD)
          remote_commit=$(git rev-parse origin/${{ github.ref_name }})
          
          echo "ðŸ“ æœ¬åœ°æäº¤: $local_commit"
          echo "ðŸ“ é ç«¯æäº¤: $remote_commit"
          
          if [ "$local_commit" != "$remote_commit" ]; then
            echo "ðŸ”„ åµæ¸¬åˆ°é ç«¯è®Šæ›´ï¼Œæ­£åœ¨åŒæ­¥..."
            
            # æš«å­˜ç•¶å‰è®Šæ›´
            if ! git diff --quiet || ! git diff --cached --quiet; then
              echo "ðŸ’¾ æš«å­˜è®Šæ›´..."
              git stash push -m "temp_changes_$(date +%s)" --include-untracked
            fi
            
            # é‡ç½®åˆ°é ç«¯ç‹€æ…‹
            git reset --hard origin/${{ github.ref_name }}
            
            # é‡æ–°åŸ·è¡Œè…³æœ¬ä»¥ç¢ºä¿æœ€æ–°ç‹€æ…‹
            echo "ðŸ”„ é‡æ–°åŸ·è¡Œè…³æœ¬..."
            python main.py
            
            # æª¢æŸ¥æ˜¯å¦é‚„æœ‰è®Šæ›´
            if [[ -z $(git status --porcelain) ]]; then
              echo "ðŸ“‹ åŒæ­¥å¾Œæ²’æœ‰è®Šæ›´ï¼ŒçµæŸæµç¨‹"
              break
            fi
          fi
          
          # æ–°å¢žè®Šæ›´
          git add .
          
          # å†æ¬¡æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if git diff --cached --quiet; then
            echo "ðŸ“‹ æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
            break
          fi
          
          # æäº¤è®Šæ›´
          echo "ðŸ’¾ æäº¤è®Šæ›´..."
          git commit -m "${commit_message}"
          
          # å˜—è©¦æŽ¨é€ - ä½¿ç”¨å®Œæ•´çš„æŽ¨é€å‘½ä»¤
          echo "ðŸš€ æŽ¨é€è®Šæ›´åˆ°é ç«¯..."
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          if git push origin HEAD:${{ github.ref_name }}; then
            echo "âœ… æˆåŠŸæŽ¨é€è®Šæ›´ (å˜—è©¦ $attempt)"
            break
          else
            echo "âš ï¸ æŽ¨é€å¤±æ•—ï¼Œæº–å‚™é‡è©¦..."
            
            if [ $attempt -eq $max_attempts ]; then
              echo "âŒ é”åˆ°æœ€å¤§å˜—è©¦æ¬¡æ•¸ï¼ŒæŽ¨é€å¤±æ•—"
              echo "ðŸ” æœ€çµ‚ç‹€æ…‹è¨ºæ–·ï¼š"
              echo "- æœ¬åœ°åˆ†æ”¯: $(git branch --show-current)"
              echo "- æœ¬åœ°æäº¤: $(git rev-parse HEAD)"
              echo "- é ç«¯æäº¤: $(git rev-parse origin/${{ github.ref_name }})"
              git status
              exit 1
            fi
            
            # é‡ç½®åˆ°æŽ¨é€å‰ç‹€æ…‹ï¼Œæº–å‚™é‡è©¦
            git reset --soft HEAD~1
            attempt=$((attempt + 1))
            sleep $((attempt * 2))  # æŒ‡æ•¸é€€é¿
          fi
        done
        
        echo "ðŸŽ‰ æäº¤æµç¨‹å®Œæˆ"
        
    # 9. é©—è­‰æœ€çµ‚ç‹€æ…‹
    - name: ðŸ” é©—è­‰æœ€çµ‚ç‹€æ…‹
      if: always()
      run: |
        echo "ðŸ” æœ€çµ‚ç‹€æ…‹é©—è­‰ï¼š"
        echo "- ç•¶å‰åˆ†æ”¯: $(git branch --show-current)"
        echo "- ç•¶å‰æäº¤: $(git rev-parse HEAD)"
        echo "- é ç«¯æäº¤: $(git rev-parse origin/${{ github.ref_name }})"
        echo "- å·¥ä½œç›®éŒ„ç‹€æ…‹:"
        git status --short || echo "  å·¥ä½œç›®éŒ„ä¹¾æ·¨"
        
        # æª¢æŸ¥ç”Ÿæˆçš„æª”æ¡ˆ
        if [ -d "data" ]; then
          echo "- ç”Ÿæˆçš„å ±å‘Šæª”æ¡ˆ:"
          ls -la data/*.md 2>/dev/null || echo "  æ²’æœ‰æ‰¾åˆ° .md æª”æ¡ˆ"
          ls -la data/*.json 2>/dev/null || echo "  æ²’æœ‰æ‰¾åˆ° .json æª”æ¡ˆ"
        fi
        
    # 10. ç”ŸæˆåŸ·è¡Œå ±å‘Š
    - name: ðŸ“Š ç”ŸæˆåŸ·è¡Œå ±å‘Š
      if: always()
      run: |
        echo "## ðŸ“Š åŸ·è¡Œå ±å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- **åŸ·è¡Œæ™‚é–“**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **æ˜¯å¦æœ‰è®Šæ›´**: ${{ steps.check_changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åŸ·è¡Œæ¨¡å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Python ç‰ˆæœ¬**: $(python --version)" >> $GITHUB_STEP_SUMMARY
        echo "- **ç•¶å‰æäº¤**: $(git rev-parse HEAD)" >> $GITHUB_STEP_SUMMARY
        
        if [[ -n "${{ github.event.inputs.custom_date }}" ]]; then
          echo "- **è‡ªè¨‚æ—¥æœŸ**: ${{ github.event.inputs.custom_date }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ github.event.inputs.force_update }}" == "true" ]]; then
          echo "- **å¼·åˆ¶æ›´æ–°**: æ˜¯" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "## âš™ï¸ è¨­å®šç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
        echo "- **API é‡‘é‘°**: ${{ secrets.GOOGLE_API_KEY && 'å·²è¨­å®š' || 'æœªè¨­å®š' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ¨¡åž‹åç¨±**: ${{ vars.MODEL_NAME || 'ä½¿ç”¨é è¨­å€¼' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è¼¸å‡ºèªžè¨€**: ${{ vars.LANGUAGE || 'ä½¿ç”¨é è¨­å€¼' }}" >> $GITHUB_STEP_SUMMARY
        
        # æª¢æŸ¥ç”Ÿæˆçš„æª”æ¡ˆ
        if [ -d "data" ]; then
          echo "## ðŸ“ ç”Ÿæˆçš„æª”æ¡ˆ" >> $GITHUB_STEP_SUMMARY
          md_count=$(ls data/*.md 2>/dev/null | wc -l)
          json_count=$(ls data/*.json 2>/dev/null | wc -l)
          echo "- **Markdown å ±å‘Š**: ${md_count} å€‹" >> $GITHUB_STEP_SUMMARY
          echo "- **JSON è³‡æ–™**: ${json_count} å€‹" >> $GITHUB_STEP_SUMMARY
        fi
        
    # 11. æ¸…ç†æš«å­˜æª”æ¡ˆ
    - name: ðŸ§¹ æ¸…ç†æš«å­˜æª”æ¡ˆ
      if: always()
      run: |
        find . -name "*.tmp" -delete 2>/dev/null || true
        find . -name "*.temp" -delete 2>/dev/null || true
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.pyc" -delete 2>/dev/null || true
