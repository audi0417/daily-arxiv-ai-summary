# GitHub Actions è‡ªå‹•åŒ–å·¥ä½œæµç¨‹
# æ¯æ—¥è‡ªå‹•æŠ“å– ArXiv è«–æ–‡ä¸¦ç”Ÿæˆ AI æ‘˜è¦

name: æ¯æ—¥ ArXiv è«–æ–‡æ™ºæ…§æ‘˜è¦æ›´æ–°

on:
  # å®šæ™‚åŸ·è¡Œï¼šæ¯æ—¥ UTC 16:30 (å°ç£æ™‚é–“ 00:30)
  schedule:
    - cron: "30 16 * * *"
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      custom_date:
        description: 'è‡ªè¨‚æ—¥æœŸ (YYYY-MM-DDï¼Œç•™ç©ºç‚ºä»Šæ—¥)'
        required: false
        type: string
      force_update:
        description: 'å¼·åˆ¶æ›´æ–° (å³ä½¿æ²’æœ‰æ–°è«–æ–‡)'
        required: false
        type: boolean
        default: false

# æ·»åŠ å¿…è¦çš„æ¬Šé™è¨­å®š
permissions:
  contents: write
  actions: read

jobs:
  update_papers:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æª¢å‡ºå„²å­˜åº«
    - name: æª¢å‡ºå„²å­˜åº«
      uses: actions/checkout@v4
      with:
        # ä½¿ç”¨å…·æœ‰æŽ¨é€æ¬Šé™çš„ token
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
      
    # 2. è¨­å®š Python ç’°å¢ƒ
    - name: è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    # 3. å®‰è£åŸºæœ¬å¥—ä»¶
    - name: å®‰è£åŸºæœ¬å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        # å…ˆå®‰è£åŸºæœ¬å¥—ä»¶ï¼Œé¿å…ä¾è³´è¡çª
        pip install requests pyyaml python-dateutil
        
    # 4. è¨­å®š Git ä½¿ç”¨è€…è³‡è¨Š
    - name: è¨­å®š Git ä½¿ç”¨è€…è³‡è¨Š
      run: |
        git config --global user.email "${{ vars.EMAIL || 'action@github.com' }}"
        git config --global user.name "${{ vars.NAME || 'GitHub Action' }}"
        
    # 5. ç¢ºä¿èˆ‡é ç«¯åŒæ­¥
    - name: åŒæ­¥é ç«¯è®Šæ›´
      run: |
        # æ‹‰å–æœ€æ–°çš„é ç«¯è®Šæ›´
        git fetch origin
        git pull origin ${{ github.ref_name }} || echo "æ²’æœ‰éœ€è¦åˆä½µçš„è®Šæ›´"
        
    # 6. åŸ·è¡Œç°¡åŒ–çš„è™•ç†è…³æœ¬
    - name: åŸ·è¡Œè«–æ–‡è™•ç†ï¼ˆç°¡åŒ–ç‰ˆï¼‰
      env:
        # API è¨­å®š
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        
        # æ¨¡åž‹è¨­å®š
        MODEL_NAME: ${{ vars.MODEL_NAME || 'gemini-2.0-flash-exp' }}
        LANGUAGE: ${{ vars.LANGUAGE || 'Traditional Chinese' }}
        
        # å·¥ä½œæµç¨‹åƒæ•¸
        CUSTOM_DATE: ${{ github.event.inputs.custom_date }}
        FORCE_UPDATE: ${{ github.event.inputs.force_update }}
        
        # GitHub ç›¸é—œ
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_NAME: ${{ github.repository }}
        
      run: |
        # åŸ·è¡Œç°¡åŒ–çš„è™•ç†è…³æœ¬
        python simple_main.py
        
    # 7. æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆè®Šæ›´
    - name: æª¢æŸ¥æª”æ¡ˆè®Šæ›´
      id: check_changes
      run: |
        if [[ -z $(git status -s) ]]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ æ²’æœ‰æª”æ¡ˆè®Šæ›´ï¼Œè·³éŽæäº¤æ­¥é©Ÿ"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ åµæ¸¬åˆ°æª”æ¡ˆè®Šæ›´ï¼Œæº–å‚™æäº¤"
          git status
        fi
        
    # 8. æ™ºæ…§æäº¤å’ŒæŽ¨é€è®Šæ›´
    - name: æäº¤å’ŒæŽ¨é€è®Šæ›´
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        # å–å¾—ä»Šæ—¥æ—¥æœŸï¼ˆå°ç£æ™‚å€ï¼‰
        today_date=$(date -u "+%Y-%m-%d")
        
        # å†æ¬¡ç¢ºä¿åŒæ­¥ï¼ˆé˜²æ­¢åŸ·è¡ŒæœŸé–“æœ‰å…¶ä»–è®Šæ›´ï¼‰
        git fetch origin
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è¡çª
        if ! git merge-base --is-ancestor HEAD origin/${{ github.ref_name }}; then
          echo "ðŸ”„ åµæ¸¬åˆ°é ç«¯æœ‰æ–°è®Šæ›´ï¼Œæ­£åœ¨åˆä½µ..."
          git pull origin ${{ github.ref_name }} --rebase || {
            echo "âŒ åˆä½µå¤±æ•—ï¼Œå˜—è©¦é‡ç½®ä¸¦é‡æ–°æ‹‰å–"
            git reset --hard origin/${{ github.ref_name }}
            # é‡æ–°åŸ·è¡Œè…³æœ¬ä»¥ç¢ºä¿æª”æ¡ˆæ˜¯æœ€æ–°çš„
            python simple_main.py
          }
        fi
        
        # æ–°å¢žæ‰€æœ‰è®Šæ›´çš„æª”æ¡ˆ
        git add .
        
        # æª¢æŸ¥æ˜¯å¦çœŸçš„æœ‰è®Šæ›´éœ€è¦æäº¤
        if git diff --cached --quiet; then
          echo "ðŸ“‹ åˆä½µå¾Œæ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
          exit 0
        fi
        
        # ç”¢ç”Ÿæäº¤è¨Šæ¯
        if [[ -n "${{ github.event.inputs.custom_date }}" ]]; then
          commit_message="ðŸ“š æ›´æ–°è«–æ–‡æ‘˜è¦: ${{ github.event.inputs.custom_date }} (æ‰‹å‹•è§¸ç™¼)"
        else
          commit_message="ðŸ“š æ¯æ—¥è«–æ–‡æ‘˜è¦æ›´æ–°: ${today_date}"
        fi
        
        # æäº¤è®Šæ›´
        git commit -m "${commit_message}"
        
        # æŽ¨é€åˆ°å„²å­˜åº«ï¼ˆé‡è©¦æ©Ÿåˆ¶ï¼‰
        max_retries=3
        retry_count=0
        
        while [ $retry_count -lt $max_retries ]; do
          echo "ðŸš€ å˜—è©¦æŽ¨é€è®Šæ›´ (ç¬¬ $((retry_count + 1)) æ¬¡)..."
          
          # è¨­å®šé ç«¯ URL
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          if git push origin HEAD:${{ github.ref_name }}; then
            echo "âœ… æˆåŠŸæäº¤ä¸¦æŽ¨é€è®Šæ›´"
            break
          else
            echo "âš ï¸ æŽ¨é€å¤±æ•—ï¼Œå˜—è©¦åŒæ­¥ä¸¦é‡è©¦..."
            retry_count=$((retry_count + 1))
            
            if [ $retry_count -lt $max_retries ]; then
              # æ‹‰å–æœ€æ–°è®Šæ›´ä¸¦å˜—è©¦é‡æ–°åˆä½µ
              git fetch origin
              if git pull origin ${{ github.ref_name }} --rebase; then
                echo "ðŸ”„ æˆåŠŸåŒæ­¥ï¼Œæº–å‚™é‡è©¦æŽ¨é€"
              else
                echo "âŒ åŒæ­¥å¤±æ•—ï¼Œå°‡åœ¨ä¸‹æ¬¡é‡è©¦"
                sleep 5
              fi
            else
              echo "âŒ é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸ï¼ŒæŽ¨é€å¤±æ•—"
              exit 1
            fi
          fi
        done
        
    # 9. ç”ŸæˆåŸ·è¡Œå ±å‘Š
    - name: ç”ŸæˆåŸ·è¡Œå ±å‘Š
      if: always()
      run: |
        echo "## ðŸ“Š åŸ·è¡Œå ±å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- **åŸ·è¡Œæ™‚é–“**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **æ˜¯å¦æœ‰è®Šæ›´**: ${{ steps.check_changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åŸ·è¡Œæ¨¡å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Python ç‰ˆæœ¬**: $(python --version)" >> $GITHUB_STEP_SUMMARY
        
        if [[ -n "${{ github.event.inputs.custom_date }}" ]]; then
          echo "- **è‡ªè¨‚æ—¥æœŸ**: ${{ github.event.inputs.custom_date }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ github.event.inputs.force_update }}" == "true" ]]; then
          echo "- **å¼·åˆ¶æ›´æ–°**: æ˜¯" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æª¢æŸ¥è¨­å®šç‹€æ…‹
        echo "## âš™ï¸ è¨­å®šç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
        echo "- **API é‡‘é‘°**: ${{ secrets.GOOGLE_API_KEY && 'å·²è¨­å®š' || 'æœªè¨­å®š' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ¨¡åž‹åç¨±**: ${{ vars.MODEL_NAME || 'ä½¿ç”¨é è¨­å€¼' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è¼¸å‡ºèªžè¨€**: ${{ vars.LANGUAGE || 'ä½¿ç”¨é è¨­å€¼' }}" >> $GITHUB_STEP_SUMMARY
        
        # å¦‚æžœæœ‰éŒ¯èª¤æª”æ¡ˆï¼Œé¡¯ç¤ºéŒ¯èª¤è³‡è¨Š
        if [[ -f "error.log" ]]; then
          echo "## âš ï¸ åŸ·è¡ŒéŽç¨‹ä¸­çš„è­¦å‘Š" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -10 error.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
    # 10. æ¸…ç†æš«å­˜æª”æ¡ˆ
    - name: æ¸…ç†æš«å­˜æª”æ¡ˆ
      if: always()
      run: |
        # æ¸…ç†å¯èƒ½ç”¢ç”Ÿçš„æš«å­˜æª”æ¡ˆ
        find . -name "*.tmp" -delete 2>/dev/null || true
        find . -name "*.temp" -delete 2>/dev/null || true
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true