# GitHub Actions è‡ªå‹•åŒ–å·¥ä½œæµç¨‹
# æ¯æ—¥è‡ªå‹•æŠ“å– ArXiv è«–æ–‡ä¸¦ç”Ÿæˆ AI æ‘˜è¦

name: æ¯æ—¥ ArXiv è«–æ–‡æ™ºæ…§æ‘˜è¦æ›´æ–°

on:
  # å®šæ™‚åŸ·è¡Œï¼šæ¯æ—¥ UTC 16:30 (å°ç£æ™‚é–“ 00:30)
  schedule:
    - cron: "30 16 * * *"
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      custom_date:
        description: 'è‡ªè¨‚æ—¥æœŸ (YYYY-MM-DDï¼Œç•™ç©ºç‚ºä»Šæ—¥)'
        required: false
        type: string
      force_update:
        description: 'å¼·åˆ¶æ›´æ–° (å³ä½¿æ²’æœ‰æ–°è«–æ–‡)'
        required: false
        type: boolean
        default: false

jobs:
  update_papers:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æª¢å‡ºå„²å­˜åº«
    - name: æª¢å‡ºå„²å­˜åº«
      uses: actions/checkout@v4
      
    # 2. è¨­å®š Python ç’°å¢ƒ
    - name: è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    # 3. å®‰è£å°ˆæ¡ˆç›¸ä¾å¥—ä»¶
    - name: å®‰è£å°ˆæ¡ˆç›¸ä¾å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    # 4. è¨­å®š Git ä½¿ç”¨è€…è³‡è¨Š
    - name: è¨­å®š Git ä½¿ç”¨è€…è³‡è¨Š
      run: |
        git config --global user.email "${{ vars.EMAIL }}"
        git config --global user.name "${{ vars.NAME }}"
        
    # 5. åŸ·è¡Œä¸»è¦å·¥ä½œæµç¨‹
    - name: åŸ·è¡Œè«–æ–‡æŠ“å–èˆ‡è™•ç†
      env:
        # API è¨­å®š
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        
        # æ¨¡åž‹è¨­å®š
        MODEL_NAME: ${{ vars.MODEL_NAME }}
        LANGUAGE: ${{ vars.LANGUAGE }}
        
        # å·¥ä½œæµç¨‹åƒæ•¸
        CUSTOM_DATE: ${{ github.event.inputs.custom_date }}
        FORCE_UPDATE: ${{ github.event.inputs.force_update }}
        
        # GitHub ç›¸é—œ
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_NAME: ${{ github.repository }}
        
      run: |
        # åŸ·è¡Œä¸»è¦è™•ç†è…³æœ¬
        python src/main.py
        
    # 6. æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆè®Šæ›´
    - name: æª¢æŸ¥æª”æ¡ˆè®Šæ›´
      id: check_changes
      run: |
        if [[ -z $(git status -s) ]]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ æ²’æœ‰æª”æ¡ˆè®Šæ›´ï¼Œè·³éŽæäº¤æ­¥é©Ÿ"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ åµæ¸¬åˆ°æª”æ¡ˆè®Šæ›´ï¼Œæº–å‚™æäº¤"
        fi
        
    # 7. æäº¤è®Šæ›´ï¼ˆå¦‚æžœæœ‰çš„è©±ï¼‰
    - name: æäº¤å’ŒæŽ¨é€è®Šæ›´
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        # å–å¾—ä»Šæ—¥æ—¥æœŸï¼ˆå°ç£æ™‚å€ï¼‰
        today_date=$(TZ=Asia/Taipei date "+%Y-%m-%d")
        
        # æ–°å¢žæ‰€æœ‰è®Šæ›´çš„æª”æ¡ˆ
        git add .
        
        # ç”¢ç”Ÿæäº¤è¨Šæ¯
        if [[ -n "${{ github.event.inputs.custom_date }}" ]]; then
          commit_message="ðŸ“š æ›´æ–°è«–æ–‡æ‘˜è¦: ${{ github.event.inputs.custom_date }} (æ‰‹å‹•è§¸ç™¼)"
        else
          commit_message="ðŸ“š æ¯æ—¥è«–æ–‡æ‘˜è¦æ›´æ–°: ${today_date}"
        fi
        
        # æäº¤è®Šæ›´
        git commit -m "${commit_message}"
        
        # æŽ¨é€åˆ°å„²å­˜åº«
        git push
        
        echo "âœ… æˆåŠŸæäº¤ä¸¦æŽ¨é€è®Šæ›´"
        
    # 8. ç”ŸæˆåŸ·è¡Œå ±å‘Š
    - name: ç”ŸæˆåŸ·è¡Œå ±å‘Š
      if: always()
      run: |
        echo "## ðŸ“Š åŸ·è¡Œå ±å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- **åŸ·è¡Œæ™‚é–“**: $(TZ=Asia/Taipei date)" >> $GITHUB_STEP_SUMMARY
        echo "- **æ˜¯å¦æœ‰è®Šæ›´**: ${{ steps.check_changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åŸ·è¡Œæ¨¡å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        
        if [[ -n "${{ github.event.inputs.custom_date }}" ]]; then
          echo "- **è‡ªè¨‚æ—¥æœŸ**: ${{ github.event.inputs.custom_date }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ github.event.inputs.force_update }}" == "true" ]]; then
          echo "- **å¼·åˆ¶æ›´æ–°**: æ˜¯" >> $GITHUB_STEP_SUMMARY
        fi
        
        # å¦‚æžœæœ‰éŒ¯èª¤æª”æ¡ˆï¼Œé¡¯ç¤ºéŒ¯èª¤è³‡è¨Š
        if [[ -f "error.log" ]]; then
          echo "## âš ï¸ åŸ·è¡ŒéŽç¨‹ä¸­çš„è­¦å‘Š" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -10 error.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
    # 9. æ¸…ç†æš«å­˜æª”æ¡ˆ
    - name: æ¸…ç†æš«å­˜æª”æ¡ˆ
      if: always()
      run: |
        # æ¸…ç†å¯èƒ½ç”¢ç”Ÿçš„æš«å­˜æª”æ¡ˆ
        find . -name "*.tmp" -delete 2>/dev/null || true
        find . -name "*.temp" -delete 2>/dev/null || true
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true