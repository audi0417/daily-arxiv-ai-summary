name: ðŸ“š ArXiv è«–æ–‡æ™ºæ…§æ‘˜è¦

on:
  # å®šæ™‚åŸ·è¡Œï¼šæ¯æ—¥ UTC 16:30 (å°ç£æ™‚é–“ 00:30)
  schedule:
    - cron: "30 16 * * *"
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      target_date:
        description: 'ç›®æ¨™æ—¥æœŸ (YYYY-MM-DDï¼Œç•™ç©ºç‚ºä»Šæ—¥)'
        required: false
        type: string
      force_update:
        description: 'å¼·åˆ¶æ›´æ–° (å³ä½¿å·²æœ‰å ±å‘Š)'
        required: false
        type: boolean
        default: false
      debug_mode:
        description: 'åµéŒ¯æ¨¡å¼ (åƒ…æ¸¬è©¦çˆ¬èŸ²åŠŸèƒ½)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  actions: read

jobs:
  update_papers:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ æª¢å‡ºå„²å­˜åº«
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
      
    - name: ðŸ è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ðŸ“¦ å®‰è£ä¾è³´å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: âš™ï¸ è¨­å®š Git ä½¿ç”¨è€…è³‡è¨Š
      if: github.event.inputs.debug_mode != 'true'
      run: |
        git config --global user.email "${{ vars.EMAIL || 'action@github.com' }}"
        git config --global user.name "${{ vars.NAME || 'ArXiv Daily Bot' }}"
        
    - name: ðŸš€ åŸ·è¡Œè«–æ–‡çˆ¬èŸ²å’Œæ‘˜è¦ç”Ÿæˆ
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        MODEL_NAME: ${{ vars.MODEL_NAME || 'gemini-2.0-flash-exp' }}
        LANGUAGE: ${{ vars.LANGUAGE || 'Traditional Chinese' }}
        CUSTOM_DATE: ${{ github.event.inputs.target_date }}
        FORCE_UPDATE: ${{ github.event.inputs.force_update }}
      run: |
        echo "ðŸš€ é–‹å§‹åŸ·è¡Œè«–æ–‡è™•ç†..."
        echo "ðŸ“… ç›®æ¨™æ—¥æœŸ: ${CUSTOM_DATE:-$(date -u '+%Y-%m-%d')}"
        echo "ðŸ”„ å¼·åˆ¶æ›´æ–°: ${FORCE_UPDATE}"
        echo "ðŸ§ª åµéŒ¯æ¨¡å¼: ${{ github.event.inputs.debug_mode }}"
        echo "ðŸ¤– AI æ¨¡åž‹: ${MODEL_NAME}"
        
        if [ "${{ github.event.inputs.debug_mode }}" = "true" ]; then
          echo "ðŸ§ª åŸ·è¡ŒåµéŒ¯æ¨¡å¼ - åƒ…æ¸¬è©¦çˆ¬èŸ²åŠŸèƒ½"
          python -c "
import logging
logging.basicConfig(level=logging.DEBUG)

print('ðŸ” æ¸¬è©¦çˆ¬èŸ²æ¨¡çµ„å°Žå…¥...')
from arxiv_crawler import ArxivCrawler

print('âœ… çˆ¬èŸ²æ¨¡çµ„å°Žå…¥æˆåŠŸ')
crawler = ArxivCrawler()
print('âœ… çˆ¬èŸ²åˆå§‹åŒ–æˆåŠŸ')

test_date = '${CUSTOM_DATE:-$(date -u '+%Y-%m-%d')}'
print(f'ðŸ” æ¸¬è©¦è«–æ–‡æŠ“å– (æ—¥æœŸ: {test_date})...')

papers = crawler.get_papers(test_date)
print(f'âœ… æˆåŠŸæŠ“å– {len(papers)} ç¯‡è«–æ–‡')

if papers:
    print('ðŸ“„ ç¬¬ä¸€ç¯‡è«–æ–‡è³‡è¨Š:')
    paper = papers[0]
    print(f'  æ¨™é¡Œ: {paper.get(\"title\", \"æœªçŸ¥\")}')
    print(f'  ä½œè€…æ•¸: {len(paper.get(\"authors\", []))}')
    print(f'  é¡žåˆ¥: {paper.get(\"categories\", [])}')
    print(f'  ArXiv ID: {paper.get(\"arxiv_id\", \"æœªçŸ¥\")}')
    print(f'  ç™¼å¸ƒæ—¥æœŸ: {paper.get(\"published\", \"æœªçŸ¥\")}')
else:
    print('âš ï¸ æ²’æœ‰æ‰¾åˆ°è«–æ–‡ï¼Œå¯èƒ½åŽŸå› :')
    print('  - ç¶²è·¯é€£æŽ¥å•é¡Œ')
    print('  - arXiv API æš«æ™‚ä¸å¯ç”¨')
    print('  - æœå°‹æ¢ä»¶éŽæ–¼åš´æ ¼')
    print('  - é€±æœ«æˆ–å‡æ—¥ï¼ŒarXiv é€šå¸¸ä¸ç™¼å¸ƒæ–°è«–æ–‡')
    
print('ðŸŽ‰ åµéŒ¯æ¸¬è©¦å®Œæˆ')
"
        else
          echo "ðŸš€ åŸ·è¡Œå®Œæ•´æµç¨‹"
          python main.py
        fi
        
    - name: ðŸ“‹ æª¢æŸ¥æª”æ¡ˆè®Šæ›´
      if: github.event.inputs.debug_mode != 'true'
      id: check_changes
      run: |
        if [[ -z $(git status --porcelain) ]]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ æ²’æœ‰æª”æ¡ˆè®Šæ›´"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ åµæ¸¬åˆ°æª”æ¡ˆè®Šæ›´"
          git status --short
        fi
        
    - name: ðŸ’¾ æäº¤å’ŒæŽ¨é€è®Šæ›´
      if: steps.check_changes.outputs.has_changes == 'true' && github.event.inputs.debug_mode != 'true'
      run: |
        today_date=$(date -u "+%Y-%m-%d")
        
        if [[ -n "${{ github.event.inputs.target_date }}" ]]; then
          commit_message="ðŸ“š è«–æ–‡æ‘˜è¦æ›´æ–°: ${{ github.event.inputs.target_date }} (æ‰‹å‹•è§¸ç™¼)"
        else
          commit_message="ðŸ“š æ¯æ—¥è«–æ–‡æ‘˜è¦æ›´æ–°: ${today_date}"
        fi
        
        git add .
        git commit -m "${commit_message}"
        git push
        
    - name: ðŸ“Š ç”ŸæˆåŸ·è¡Œå ±å‘Š
      if: always()
      run: |
        echo "## ðŸ“Š åŸ·è¡Œå ±å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- **åŸ·è¡Œæ™‚é–“**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **åŸ·è¡Œæ¨¡å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åµéŒ¯æ¨¡å¼**: ${{ github.event.inputs.debug_mode || 'false' }}" >> $GITHUB_STEP_SUMMARY
        
        if [[ -n "${{ github.event.inputs.target_date }}" ]]; then
          echo "- **ç›®æ¨™æ—¥æœŸ**: ${{ github.event.inputs.target_date }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ github.event.inputs.force_update }}" == "true" ]]; then
          echo "- **å¼·åˆ¶æ›´æ–°**: æ˜¯" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âš™ï¸ ç³»çµ±ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
        echo "- **API é‡‘é‘°**: ${{ secrets.GOOGLE_API_KEY && 'å·²è¨­å®š' || 'æœªè¨­å®š' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ¨¡åž‹åç¨±**: ${{ vars.MODEL_NAME || 'ä½¿ç”¨é è¨­å€¼' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è¼¸å‡ºèªžè¨€**: ${{ vars.LANGUAGE || 'ä½¿ç”¨é è¨­å€¼' }}" >> $GITHUB_STEP_SUMMARY
        
        # æª¢æŸ¥ç”Ÿæˆçš„æª”æ¡ˆ
        if [ -d "data" ] && [ "${{ github.event.inputs.debug_mode }}" != "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ ç”Ÿæˆçš„æª”æ¡ˆ" >> $GITHUB_STEP_SUMMARY
          md_count=$(ls data/*.md 2>/dev/null | wc -l)
          json_count=$(ls data/*.json 2>/dev/null | wc -l)
          echo "- **Markdown å ±å‘Š**: ${md_count} å€‹" >> $GITHUB_STEP_SUMMARY
          echo "- **JSON è³‡æ–™**: ${json_count} å€‹" >> $GITHUB_STEP_SUMMARY
        fi
